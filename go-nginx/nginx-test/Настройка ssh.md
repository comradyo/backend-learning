# Настройка удаленного сервера

1. Как подключаться? <br />
ssh username@server_ip -p 22 <br />
И ввести пароль

2. Как создать нового пользователя и задать ему пароль?

3. Как запретить входить под root? И разрешить входить только под созданным мною пользователем?

4. Как закрыть порты?

5. Как настроить ssh? Как настроить ssh ключ?
Установить (хз, что именно из этого нужно) <br />
``` bash
sudo apt install openssh-server
sudo apt-get install ssh
# (если есть проблема при установке, выполнить предлагаемую инструкцию)
```
Проверка статуса <br />
``` bash
sudo systemctl status ssh
```

## Создание пары ключей
https://timeweb.cloud/tutorials/ubuntu/ustanovka-i-nastrojka-ssh-na-servere <br />

Чтобы сделать соединение еще более безопасным, а аутентификацию — удобной, используют пару ключей: открытый и закрытый. <br />
Открытый хранится на хосте, закрытый — на компьютере пользователя. <br />

Чтобы сгенерировать новую пару 2048-битных ключей RSA, откройте терминал (на сервере или локально? Ответ: локально, закрытый ключ будет на компе, а открытый -- на сервере, и туда мы его перекинем) и выполните приведенную ниже команду: <br />
```
ssh-keygen -t rsa
```

Появится вопрос, куда сохранить ключи. Если вы нажмете Enter, по умолчанию пара ключей будет сохранена в подкаталоге .ssh папки home. Вы также можете указать альтернативный путь, где вы хотите сохранить пару ключей. Но рекомендуется использовать каталог по умолчанию. Это заметно упрощает дальнейшее управление.

Если вы уже создали пару ключей на клиентском компьютере, вам будет предложено перезаписать ее. Выбор полностью зависит от вас, но будьте осторожны. Если вы выберете перезапись, то не сможете использовать предыдущую пару ключей для входа на сервер. Она будет удалена. Исправить конфликт легко — достаточно указывать для каждой новой пары уникальное имя. Папка для хранения при этом может оставаться одной и той же.

Проверка, что ключ создался:
```
ls -l ~/.ssh/id_*.pub 
```

Вам также предложат ввести парольную фразу, чтобы добавить дополнительный уровень безопасности, который предотвращает доступ неавторизованных пользователей к хосту. Просто нажмите Enter, если вы не хотите вводить парольную фразу.

Что нужно сделать для создания нескольких ssh ключей ддя разных хостов? <br />
Ответ: создавать файлы с ключами с разными названиями и настроить конфигурационный файл.

Как создать и настроить файл конфигураций? Где он будет храниться? <br />
```
vi ~/.ssh/config
```

Назвал файл с закрытым ключом "server_test_rsa" <br />

```
Host myshortname realname.example.com
    HostName realname.example.com
    IdentityFile ~/.ssh/realname_rsa # private key for realname
    User root

Host myother realname2.example.org
    HostName realname2.example.org
    IdentityFile ~/.ssh/realname2_rsa  # different private key for realname2
    User remoteusername
```

Конкретный пример (ip поменял):
```
Host server_test
    HostName 37.234.173.208
    IdentityFile ~/.ssh/server_test_rsa
    User root
```

В таком случае, подключаться к серверу можно вот так:
```
ssh root@server_test
```

Приватный ключ можно посмотреть через команду: <br />
```
cat /root/.ssh/id_rsa
```

Что с ним делать? Нужен ли он? <br />
Ответ: по-видимому, он будет подтягиваться с помощью конфигурационного файла.

Как теперь подключаться по ssh? <br />
Сначала нужно добавить ключ на сервер.

## Добавление ключа на сервер
Закрытый ключ хранится на компьютере. Его нельзя никому передавать. А вот открытую часть необходимо перенести на сервер.

Если у вас есть доступ к хосту по паролю, можно перенести открытый ключ с помощью ssh-copy-id. Пример команды:
```
ssh-copy-id -i ~/.ssh/mykey user@host
```

Конкретный пример меня:
```
ssh-copy-id -i ~/.ssh/server_test_rsa.pub root@37.234.173.208
```

После того, как это сделано, и в случае, если есть конфигурационный файл, нужно выполнить следующие команды:
```
ssh-agent bash
ssh-add ~/.ssh/server_test_rsa
```
Если имя ключа отличается от стандартного, его автоматическое добавление куда-то там не работает, поэтому используем эту команду. <br>
UPD: почему-то пришлось повторно использовать команду. Кажется, она активирует возможность работать без пароля только для текущей сессии терминала.

Чтобы подключиться с помощью ключей, выполнить команду:
```  
ssh root@37.234.173.208
```
Или, с учетом настройки конфигурационного файла:
```
ssh root@server_test
```

## Отключение аутентификации по паролю

Чтобы отключить аутентификацию по паролю, подключитесь к серверу с правами root и отредактируйте файл sshd_config. 
Откройте его и измените параметр PasswordAuthentication. Вместо ‘Yes’ установите значение ‘No’. 

```
vi /etc/ssh/sshd_config
```

Примечание: <br />
> Ubuntu/Debian distributions have the non-standard entry Include /etc/ssh/sshd_config.d/*.conf at the beginning of the distribution sshd_config The purpose of this is to allow users to customize their sshd configuration without modifying the core sshd_config file, which can minimize conflicts or unexpected configuration changes on apt update of OpenSSH.
>
> Because the first encountered configuration line is the one applied, any password commands in a custom configuration file in /etc/ssh/sshd_config.d/*.conf will pre-empt the PasswordAuthentication no line in the primary configuration. Ensure that all configuration is as you expect.

То есть, редактировать можно вот этот файл (не знаю, почему он называется именно так, видимо, это как-то связано с сервером. Но файл называться может как угодно. Если его нет, можно его создать):
```
vi /etc/ssh/sshd_config.d/50-cloud-init.conf
```

Перед редактированием рекомендуется сделать резервную копию файла:
```
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.factory-defaults
```

После внесения этого изменения перезапустите службу SSH, выполнив следующую команду от имени пользователя root:
```
sudo systemctl restart sshd
```

После этого исчезнет возможность использовать для аутентификации пароли. Подключиться можно будет только с помощью ключей SSH Linux.

## Отключение доступа для root

В Ubuntu на удаленном хосте отредактируйте файл конфигурации и установите параметр, чтобы отключить root-доступ через SSH.

Откройте файл Ubuntu SSH config для редактирования:
```  
sudo vi /etc/ssh/sshd_config.d/50-cloud-init.conf
```
Изменить значение PermitRootLogin на ‘prohibit-password’. Такая разрешает аутентификацию пользователя root с помощью любого другого разрешенного механизма (в т.ч. через ключи), кроме пароля. 

Изменить значени PubkeyAuthentication на ‘yes’. Означает, что мы можем подсоединяться к серверу через ssh ключ (вроде, можно и не указывать, оно само должно работать).

С приведенной выше конфигурацией вы сможете войти в систему как пользователь root с закрытым ключом. 
Главное, чтобы открытый ключ был скопирован в систему до перезапуска службы SSH-сервера.

Чтобы применить обновленную конфигурацию, перезапустите службу:
```
sudo systemctl restart sshd
```

## Изменение стандартного порта

По умолчанию Open Server Ubuntu использует 22 порт. Чтобы повысить безопасность, вы можете установить любое другое значение. Рекомендуется использовать порты из верхнего диапазона — от 50000 до 65000. Желательно подбирать номера, в которых все цифры отличаются, например 56713.

Откройте файл конфигурации:
```
sudo vi /etc/ssh/sshd_config.d/50-cloud-init.conf
```

Раскомментируйте строку ‘Port 22’ (если она есть, если нет - написать). 
Вместо 22 укажите другой номер — например, ‘Port 56713’ (и запомните его). 
Сохраните изменения и закройте файл.

Чтобы применить конфигурацию, перезапустите службу:
```
sudo systemctl restart sshd
```
После успешного перезапуска убедитесь, что теперь подключение проходит по другому порту:
```
ssh -p 56713 user@ip_server
```
Чтобы не вводить порт каждый раз, его можно указать в файле конфигурации `~/.ssh/config` на локальном компьютере, и добавить для хоста поле Port со значением нужного порта (т.е. `Port 56713`). <br />
В таком случае, подключаться можно просто через команду:
```
ssh root@server_test
```

## Создание нового пользователя с правами sudo
https://timeweb.cloud/tutorials/ubuntu/sozdanie-novogo-polzovatelya-sudo-ubuntu

Подключиться через root:

```
ssh root@server_test
```

Далее необходимо создать нового пользователя, дав ему произвольное имя:
```  
adduser test_user
```

В консольном терминале появится несколько сообщений, сообщающих о создании нового пользователя, отдельной группы, в которую он автоматически был добавлен, и директории, связанной с этим пользователем. Пароль задал как `password`.

Закончив заполнение данных, нужно ввести в консоль символ `y`, после чего процесс создания нового пользователя можно считать завершенным.

## Добавление пользователя в группу sudo
Нового пользователя необходимо добавить в специальную группу sudo, которая наделит его расширенными полномочиями:
```
usermod -aG sudo test_user
```
- Флаг -a необходим, чтобы указанная группа не заменила множество других групп, в которых пользователь уже состоит. В данном примере пользователь test_user как минимум состоит в ранее созданной группе test_user.
- Флаг -G необходим для указания дополнительной группы, в которую будет добавлен пользователь. Он отличается от флага -g, который устанавливает основную группу пользователя. В данном примере основной группой пользователя test_user является группа test_user.

Таким образом созданный пользователь получает дополнительные привилегии, соответствующие специальной группе sudo.

Теперь можно переключиться на нового пользователя:
```
su - test_user
```
Сразу после переключения в консольном терминале появится сообщение о том, что теперь можно выполнять команды от имени администратора (root) с помощью sudo:
> To run a command as administrator (user "root"), use "sudo <command>".
> See "man sudo_root" for details.

Команда `whoami` показывает, под каким пользователем выполняются команды.

Для тестирования привилегий нового пользователя можно попробовать вывести содержимое системной директории /root:
```
sudo ls -la /root
```

Смена пользователя обратно на root:
```
su - root
```

## Подключение через ssh к пользователю, отличному от root

Начать редактировать файл конфигурации ssh на сервере:
```
sudo vi /etc/ssh/sshd_config.d/50-cloud-init.conf
```
Отключить (закомментировать) опцию `PasswordAuthentication`, т.е. `#PasswordAuthentication no`. <br />
Изменить значение PermitRootLogin на `no`. В таком случае, подсоединяться к серверу через root будет нельзя. 

Перезапустить службу ssd
```
sudo systemctl restart sshd
```

Выполнить ssh-copy-id для нужного пользователя (указал опцию порта, т.к. поменяли основной порт на другой):
```
ssh-copy-id -i ~/.ssh/mykey -p port_number user@host
```
В моём случае:
```
ssh-copy-id -i ~/.ssh/server_test_rsa.pub -p 56713 test_user@37.234.173.208
```
Ввести пароль, протестировать:
```
ssh -p '56713' 'test_user@37.234.173.208'
```
Или
```
ssh test_user@server_test
```

Отредактировать файл конфигурации:
```
sudo vi /etc/ssh/sshd_config.d/50-cloud-init.conf
```
И добавить параметр `AllowUsers`:
```
AllowUsers User_name_1 User_name_2
```
В моём случае (не даем подключиться через root):
```
AllowUsers test_user
```

--------------
Порядок действий:
1. Купить сервер
2. Получить пользователя и пароль
3. Создать своего пользователя и запретить входить под root
4. sudo apt-get update, sudo apt-get upgrade
5. 

